# https://stackoverflow.com/questions/66466082/how-do-i-write-a-snakemake-input-when-not-all-jobs-successfully-output-files-fro

configfile: "config.yaml"
FIELD = config['FIELD']
CUBE = str(config['CUBE'])
DATA = str(config['PATH_TO_DATA'])
SOFTWARE = str(config['PATH_TO_SOFTWARE'])
CBEAMS = str(config['PATH_TO_CBEAMS'])
APERCAL = str(config['PATH_TO_APERCAL'])

beams, = glob_wildcards(DATA+"/"+FIELD+"/HI_B0{xx}_cube"+CUBE+"_image.fits")

wildcard_constraints:
    beam="\d+"

rule all:
    input:
        DATA+"/mos_" + FIELD + "/rename_cube"+CUBE+".txt",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_beams_cube"+CUBE+".png",
        DATA+"/mos_" + FIELD + "/sm_rename_cube"+CUBE+".txt",
        DATA+"/mos_"+FIELD+"/sm_"+FIELD+"_beams_cube"+CUBE+".png"
        
        # expand(DATA+"/"+FIELD+"/HI_B0{beam}_cube"+CUBE+".txt", beam=beams),
        # DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image.fits",
        # DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_noise.fits",
        # DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_weights.fits",

rule make_bin_mask:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_cat_edit.txt",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask.fits"
    output:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin.fits"
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/binary_mask.py -d "+DATA+" -t "+FIELD+" -c "+CUBE+" -j "+str(workflow.cores)

rule dilate_mask:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin.fits"
    output:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin_dil.fits"
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/dilate_binmask.py -d "+DATA+" -t "+FIELD+" -c "+CUBE+" -j "+str(workflow.cores)

rule regrid_masks:
    input:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_image.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin_dil.fits"
    output:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin_dil{bm}_regrid.fits"
    threads:
        7
#        #5  # Normal
#        3  # MDS fields (should really be doing this with memory allocation not threads
    resources:
        mem_mb = 55000
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/regridmask.py {input[0]} {input[1]}"

rule generate_new_pb:
    input:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_image.fits",
        CBEAMS+"/{bm}_gp_avg_orig.fits"
    output:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_spline_clean_pb.fits"
    threads:
        1
    run:
        shell("python3 "+SOFTWARE+"/aper_cube_stack/modules/regrid_aperpb.py -t {input[0]} -b {wildcards.bm} -p "+CBEAMS+"/")
        shell("mv "+DATA+"/"+FIELD+"/HI_B0{wildcards.bm}_cube"+CUBE+"_pb.fits {output}")

rule stack_psf:
    input:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_image.fits"
    output:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_psf.fits"
    threads:
        4   # This is a trick to not exceed the total memory (see below; sad face)
    resources:
        mem_mb = 30000 # For AWES;  MEMORY PER CORE NOT TOTAL!!!
      #  mem_mb = 185000  # For MDS 
    shell:
        "python3 "+SOFTWARE+"/aper_cube_stack/psf_stack.py -f "+FIELD+" -b {wildcards.bm} -c "+CUBE+" -d "+DATA

rule clean:
    input:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_image.fits",
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_psf.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin_dil{bm}_regrid.fits"
    output:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+".txt",
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_spline.fits",
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_spline_clean_image.fits"
    threads:
        4
    resources:
        mem_mb = 32000
    singularity:
        APERCAL+"/apercal.sif"
    shell:
        "python "+SOFTWARE+"/aper_sf2/clean3.py -c "+CUBE+" -j {threads} -t "+FIELD+" -b {wildcards.bm} -d "+DATA+"; touch {output[0]}"

def aggregate_input(wildcards):
    found_files = expand(DATA+"/"+FIELD+"/HI_B0{xx}_cube"+CUBE+"_spline_clean_image.fits", xx=beams)
    found_files2 = expand(DATA+"/"+FIELD+"/HI_B0{xx}_cube"+CUBE+"_spline_clean_pb.fits", xx=beams)
    return found_files+found_files2

rule make_mosaic_clean:
    input:
        pb = aggregate_input,
    output:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_noise.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_weights.fits"
    threads:
        workflow.cores
    run:
        input = list(input)
        mos_params = " ".join([i.split("/")[-1] for i in input if "spline_clean_image" in i])
        os.system('mosaic-queen -mc 0.1 -n '+FIELD+'_HIcube'+CUBE+'_clean -i '+FIELD+' -o mos_'+FIELD+' -t '+mos_params+' -r')
        os.system('rm -rf '+DATA+'/mos_'+FIELD+'/*imageR*')
        os.system('rm -rf '+DATA+'/mos_'+FIELD+'/*pbR*')
        os.system('rm -rf '+DATA+'/mos_'+FIELD+'/*image_fields*')
        os.system('rm -rf '+DATA+'/'+FIELD+'/HI_B0{bm}_cube'+CUBE+'_spline_clean_pb.fits')
        os.system('rm -rf '+DATA+'/'+FIELD+'/HI_B0{bm}_cube'+CUBE+'_spline.fits')

rule run_sofia_clean:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin_dil.fits"
    output:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image_cat.txt",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image_cat.xml",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image_mask-2d.fits"
    threads:
        10  # Same as what's coded into the template file.  No advantage of going higher because only applying existing mask.
    shell:
        "/usr/bin/sofia "+SOFTWARE+"/aper_sf2/sofia_final_template.par input.data={input[0]} input.mask={input[1]}"

rule generate_full_spec:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image_cat.xml"
    output:
        DATA+"/mos_"+FIELD+"/specfull_cube"+CUBE+".txt"
    threads:
        1
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/get_specfull.py -t "+FIELD+" -c "+CUBE+"; "
        "touch {output}"

rule run_sip:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image_cat.xml",
        DATA+"/mos_"+FIELD+"/specfull_cube"+CUBE+".txt"
    output:
        DATA+"/mos_"+FIELD+"/sip_cube"+CUBE+".txt"
    threads:
        1
    shell:
        "sofia_image_pipeline -c {input[0]} -s panstarrs 'GALEX Near UV' -i 5 -m; "
        "touch {output}"

rule edit_sip_figs:
    input:
        DATA+"/mos_"+FIELD+"/sip_cube"+CUBE+".txt"
    output:
        DATA+"/mos_"+FIELD+"/sip_cube"+CUBE+"_edit.txt"
    threads:
        1
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/edit_sip_images.py -t "+FIELD+" -c "+CUBE+"; "
        "touch {output}"

rule rename_pngs:
    input:
        DATA+"/mos_" + FIELD + "/sip_cube"+CUBE+"_edit.txt"
    output:
        DATA+"/mos_" + FIELD + "/rename_cube"+CUBE+".txt"
    threads:
        1
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/rename_combo.py -t " + FIELD + " -c "+CUBE+"; "
        "touch {output}"

rule generate_psf_stats:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image_cat.txt"#,
        # DATA+"/mos_"+FIELD+"/rename_cube"+CUBE+".txt"
    output:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_beams_cube"+CUBE+".png"
    threads:
        1
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/record_beams.py -t "+FIELD+" -c "+CUBE+"; "
        "python3 "+SOFTWARE+"/aper_sf2/src/plot_beams.py -t "+FIELD+" -c "+CUBE

rule smooth:
    input:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_spline_clean_image.fits"
    output:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_spline_clean_smooth_image.fits"
    singularity:
        APERCAL+"/apercal.sif"
    threads:
        4
    shell:
        "python "+SOFTWARE+"/aper_sf2/src/smooth_wa2.py -t "+FIELD+" -b {wildcards.bm} -c "+CUBE+" -j {threads}"

rule generate_smooth_pb:
    input:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_spline_clean_smooth_image.fits",
        CBEAMS+"/{bm}_gp_avg_orig.fits"
    output:
        DATA+"/"+FIELD+"/HI_B0{bm}_cube"+CUBE+"_spline_clean_smooth_pb.fits"
    threads:
        1
    shell:
        "python3 "+SOFTWARE+"/aper_cube_stack/modules/regrid_aperpb.py -t {input[0]} -b {wildcards.bm} -p "+CBEAMS+"/"

def aggregate_input2(wildcards):
    found_files = expand(DATA+"/"+FIELD+"/HI_B0{xx}_cube"+CUBE+"_spline_clean_smooth_image.fits", xx=beams)
    found_files2 = expand(DATA+"/"+FIELD+"/HI_B0{xx}_cube"+CUBE+"_spline_clean_smooth_pb.fits", xx=beams)
    return found_files+found_files2

checkpoint make_mosaic_smooth:
    input:
        pb = aggregate_input2,
    output:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_noise.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_weights.fits",
    threads:
        workflow.cores
    run:
        input = list(input)
        mos_params = " ".join([i.split("/")[-1] for i in input if "spline_clean_smooth_image" in i])
        os.system('mosaic-queen -mc 0.1 -n '+FIELD+'_HIcube'+CUBE+'_clean_smooth -i '+FIELD+' -o mos_'+FIELD+' -t '+mos_params+' -r')
        os.system('rm -rf '+DATA+'/mos_'+FIELD+'/*imageR*')
        os.system('rm -rf '+DATA+'/mos_'+FIELD+'/*pbR*')
        os.system('rm -rf '+DATA+'/mos_'+FIELD+'/*image_fields*')
        os.system('rm -rf '+DATA+'/'+FIELD+'/*spline_clean_smooth_pb.fits')
        os.system('rm -rf '+DATA+'/mos_'+FIELD+'/*regrid*')
        os.system('rm -rf '+DATA+'/mos_'+FIELD+'/*hdr')

rule dilmask_smooth:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin_dil.fits"
    output:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin_dil_sm.fits"
    threads:
        workflow.cores
    shell:
        "python "+SOFTWARE+"/aper_sf2/src/dilate_binmask.py -t "+FIELD+" -c "+CUBE+" -f {input[1]} -s sm"

rule run_sofia_smooth:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_image_sofiaFS_mask_bin_dil_sm.fits"
    output:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image_cat.txt",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image_cat.xml",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image_mask-2d.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image_mask.fits"
    threads:
        10  # Same as what's coded into the template file.  No advantage of going higher because only applying existing mask.
    shell:
        "/usr/bin/sofia "+SOFTWARE+"/aper_sf2/sofia_final_template.par input.data={input[0]} input.mask={input[1]}"

rule generate_full_spec_smooth:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image.fits",
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image_cat.xml"
    output:
        DATA+"/mos_"+FIELD+"/sm_specfull_cube"+CUBE+".txt"
    threads:
        1
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/get_specfull.py -t "+FIELD+" -c "+CUBE+" -p sm; "
        "touch {output}"

rule run_sip_smooth:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image_cat.xml",
        # "mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_image.fits",
        DATA+"/mos_"+FIELD+"/sm_specfull_cube"+CUBE+".txt"
    output:
        DATA+"/mos_"+FIELD+"/sm_sip_cube"+CUBE+".txt"
    threads:
        1
    shell:
        "sofia_image_pipeline -c {input[0]} -s panstarrs -i 5 -m; "
        #"sofia_image_pipeline -c {input[0]} -s 'DSS2 Blue' 'GALEX Near UV' -i 5 -m; "
        "touch {output}"

rule edit_sip_figs_smooth:
    input:
        DATA+"/mos_"+FIELD+"/sm_sip_cube"+CUBE+".txt"
    output:
        DATA+"/mos_"+FIELD+"/sm_sip_cube"+CUBE+"_edit.txt"
    threads:
        1
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/edit_sip_images.py -t "+FIELD+" -c "+CUBE+" -w; "
        "touch {output}"

rule rename_pngs_smooth:
    input:
        DATA+"/mos_" + FIELD + "/sm_sip_cube"+CUBE+"_edit.txt"
    output:
        DATA+"/mos_" + FIELD + "/sm_rename_cube"+CUBE+".txt"
    shell:
        "python3 "+SOFTWARE+"/aper_sf2/src/rename_combo.py -t " + FIELD + " -c "+CUBE+" -p sm -w; "
        "touch {output}"

rule generate_psf_stats_smooth:
    input:
        DATA+"/mos_"+FIELD+"/"+FIELD+"_HIcube"+CUBE+"_clean_smooth_image_cat.txt"#,
        # DATA+"/mos_"+FIELD+"/sm_rename_cube"+CUBE+".txt"
    output:
        DATA+"/mos_"+FIELD+"/sm_"+FIELD+"_beams_cube"+CUBE+".png"
    threads:
        1
    run:
        shell("python3 "+SOFTWARE+"/aper_sf2/src/record_beams.py -t "+FIELD+" -c "+CUBE+"; ")
        shell("python3 "+SOFTWARE+"/aper_sf2/src/plot_beams.py -t "+FIELD+" -c "+CUBE)
        shell("rm -rf "+DATA+"/mos_"+FIELD+"/*bin*")
